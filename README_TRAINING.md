# 競艇予測モデル - 訓練ガイド

このドキュメントでは、競艇予測モデルの訓練手順とハイパーパラメータチューニングの方法を説明します。

---

## 目次

1. [前提条件](#前提条件)
2. [データ収集](#データ収集)
3. [モデル訓練の基本フロー](#モデル訓練の基本フロー)
4. [ハイパーパラメータチューニング](#ハイパーパラメータチューニング)
5. [精度向上のヒント](#精度向上のヒント)
6. [目標精度について](#目標精度について)

---

## 前提条件

### 環境構築

```bash
# 必要なPythonパッケージをインストール
pip install xgboost scikit-learn pandas numpy psycopg2-binary python-dotenv scipy

# データベース接続情報を設定
# .env ファイルに以下を記載:
DATABASE_URL=postgresql://user:password@host:port/database
```

### 最低限必要なデータ量

| 項目 | 推奨値 | 最低値 |
|------|--------|--------|
| レース数 | 10,000レース以上 | 1,000レース |
| データ期間 | 1年分以上 | 3ヶ月分 |
| データ件数 | 60,000件以上 | 6,000件 |

---

## データ収集

### Step 0: データ収集状況の確認（推奨）

データ収集を開始する前、または途中で、現在の状況を確認できます。

```bash
# データベースの現在の状態を確認
python scraper/check_data_status.py
```

**出力内容:**
- 現在のレース数、選手数、データ期間
- 会場別統計テーブルの有無
- 天気データの有無
- 次に推奨されるステップ

### Step 1: 直近データの収集

まず、直近1週間分のデータを収集してシステムの動作確認を行います。

```bash
# 直近1週間分のデータを収集
python scraper/collect_all_venues.py
```

**所要時間:** 約3-4時間（レート制限により）

### Step 2: 過去データの段階的収集

GitHub Actionsを使用して過去データを自動収集します。

#### 手動実行（推奨）

1. GitHubリポジトリページにアクセス
2. **Actions** タブを開く
3. **Scrape Historical Data** ワークフローを選択
4. **Run workflow** をクリック
5. パラメータを設定:
   - **phase**: 1（直近1年分）
   - **days**: 7（1回で7日分）

#### 自動実行

- GitHub Actionsは毎日深夜3時（JST）に自動的に1日分ずつ収集します
- 完全に自動化したい場合は、何もせずに待つだけでOKです

#### データ収集の進捗確認

```bash
# データベースに接続して確認
python scraper/verify_data.py
```

---

## モデル訓練の基本フロー

### Option 1: クイックスタート（デフォルトパラメータ）

最初はデフォルトのハイパーパラメータで訓練し、モデルの精度を確認します。

```bash
# デフォルトパラメータでモデル訓練
python ml/evaluate_model.py
```

**出力:**
- 訓練済みモデル: `ml/trained_model.pkl`
- Overall Accuracy（全体精度）
- 1着予測精度
- 特徴量重要度

**所要時間:** 5-20分（データ量による）

### Option 2: ハイパーパラメータ最適化版（推奨）

より高い精度を目指す場合は、ハイパーパラメータチューニングを実施します。

#### Step 2-1: ハイパーパラメータ最適化

```bash
# 最適なハイパーパラメータを探索
python ml/hyperparameter_tuning.py
```

**処理内容:**
- RandomizedSearchCVによる効率的な探索
- 50回の試行（n_iter=50）
- 5分割交差検証（cv_folds=5）
- 合計250回のモデル訓練

**所要時間:** 2-6時間（データ量とマシンスペックによる）

**出力:**
- `ml/best_params_latest.json` - 最適パラメータ
- `ml/best_params_YYYYMMDD_HHMMSS.json` - タイムスタンプ付き

#### Step 2-2: 最適パラメータでモデル訓練

```bash
# 最適化されたパラメータでモデルを訓練
python ml/train_model.py
```

**出力:**
- `ml/trained_model_latest.pkl` - 最新モデル
- `ml/trained_model_YYYYMMDD_HHMMSS.pkl` - タイムスタンプ付き
- `ml/metrics_YYYYMMDD_HHMMSS.json` - 評価メトリクス

**所要時間:** 5-20分

---

## ハイパーパラメータチューニング

### 探索されるパラメータ

| パラメータ | 探索範囲 | 説明 |
|-----------|---------|------|
| `max_depth` | 3-12 | 決定木の最大深さ（大きいほど複雑） |
| `learning_rate` | 0.01-0.20 | 学習率（小さいほど慎重に学習） |
| `n_estimators` | 100-500 | 決定木の数（多いほど精度向上、計算時間増） |
| `subsample` | 0.6-1.0 | データのサブサンプリング率 |
| `colsample_bytree` | 0.6-1.0 | 特徴量のサブサンプリング率 |
| `min_child_weight` | 1-10 | 子ノードの最小重み |
| `gamma` | 0-0.5 | 分割の最小損失削減量 |
| `reg_alpha` | 0-1.0 | L1正則化項 |
| `reg_lambda` | 0-2.0 | L2正則化項 |

### カスタマイズ

試行回数を増やしてより良いパラメータを探索:

`ml/hyperparameter_tuning.py` を編集:
```python
# 223行目付近
best_params, best_score = optimize_hyperparameters(
    X, y,
    n_iter=100,     # 50 → 100 に変更
    cv_folds=5
)
```

---

## 精度向上のヒント

### 1. データ量を増やす

**現在のデータ量が少ない場合（1,000レース未満）:**
```bash
# より多くの過去データを収集
# GitHub Actionsで手動実行する際に days パラメータを増やす
# 例: days=30 で30日分を一度に収集
```

**目安:**
- 1,000レース → Overall Accuracy 20-25%
- 5,000レース → Overall Accuracy 25-30%
- 10,000レース以上 → Overall Accuracy 30-40%
- **20,000レース以上 + 全機能実装 → Overall Accuracy 45-50%**

### 2. 時系列重み付けを使用する（✅ 実装済み、+2-3%）

モデル訓練時に、新しいデータほど重要度を高くする機能が実装されています。

```bash
# 自動的に有効化されます
python ml/train_model.py
```

**仕組み:**
- 最新データ（1ヶ月以内）: 重み 1.0
- 1年前のデータ: 重み 0.81
- 3年前のデータ: 重み 0.50（半減期）
- 10年前のデータ: 重み 0.09

**効果:** 20年分のデータを効果的に活用し、+2-3%の精度向上

### 3. 会場別選手成績を計算する（✅ 実装済み、+1-2%）

選手の会場別（当地）成績を計算して使用します。

```bash
# データが5,000レース以上溜まったら実行
python ml/advanced_stats.py
```

**作成されるデータ:**
- 会場別勝率
- 会場別2連対率・3連対率
- 会場別平均スタートタイミング

**効果:** 選手と会場の相性を考慮し、+1-2%の精度向上

### 4. 天気データを収集する（✅ 実装済み、+5-10%）

競艇において最も重要な風速・風向きなどの天気データを収集します。

```bash
# 手動で天気データを収集
python scraper/weather_scraper.py

# または GitHub Actions で自動収集（1日3回）
# .github/workflows/scrape_weather.yml
```

**収集データ:**
- 風速・風向き（最重要）
- 気温・水温
- 波高
- 天気状態

**注意:** 各会場のHTML構造が異なる可能性があるため、初回実行時は調整が必要

**効果:** 風向きなど重要な要素を考慮し、+5-10%の精度向上

### 5. 特徴量の改善（今後の実装候補）

#### さらに追加可能な特徴量

1. **オッズデータ**
   - 単勝オッズ
   - 2連単オッズ
   - 市場の期待値

2. **モーターの詳細データ**
   - 節間成績
   - 部品交換履歴

3. **選手の体重・調整体重**

#### 特徴量追加の実装手順

`ml/feature_engineer.py` を編集して新しい特徴量を追加します。

### 6. データの質を確認

```bash
# データの整合性をチェック
python scraper/check_data_status.py

# または詳細確認
python scraper/verify_data.py
```

確認項目:
- 欠損値が多くないか（10%以下が理想）
- 各レースに6艇のデータが揃っているか
- 着順データに異常値がないか

### 7. 評価指標の確認

モデルの性能は以下の指標で評価します:

| 指標 | 目標値 | 説明 |
|------|--------|------|
| **Overall Accuracy** | 30-40% | 全着順の予測精度 |
| **1着予測精度** | 35-45% | 最重要：1着を当てる精度 |
| **Top-3予測精度** | 60-70% | 1着予測が上位3艇に入る確率 |
| **Log Loss** | < 1.5 | 確率予測の精度（小さいほど良い） |

---

## 目標精度について

### 目標: 30-40%の精度

競艇の予測において **30-40%の精度は非常に高い** です。

#### 理由

1. **ランダム予測の場合**
   - 6艇中1艇を当てる確率: 16.7%
   - 30%の精度 = ランダムの約1.8倍

2. **競艇のランダム性**
   - スタート事故
   - 選手の調子
   - 水面状況の変化
   - など、予測不可能な要素が多い

3. **プロの予想家でも**
   - 的中率30%前後が一般的
   - 40%を超えるのは非常に困難

#### 精度向上のステップ

| フェーズ | データ量 | 目標精度 | 実施内容 |
|---------|---------|---------|---------|
| Phase 1 | 1,000レース | 20-25% | 基本モデルの構築 |
| Phase 2 | 5,000レース | 25-30% | ハイパーパラメータチューニング |
| Phase 3 | 10,000レース以上 | 30-35% | 特徴量エンジニアリング |
| Phase 4 | 20,000レース以上 + 天気データ | 35-40% | 高度な最適化 |

---

## トラブルシューティング

### データが取得できない

```bash
# データベース接続を確認
python scraper/test_db.py

# スクレイピングのテスト
python scraper/test_scraping.py
```

### メモリ不足エラー

データ量が多い場合、メモリ不足になる可能性があります。

**対策:**
```python
# ml/train_model.py または ml/hyperparameter_tuning.py を編集
# prepare_features() 関数内で処理するレース数を制限

# 172行目付近
if race_count >= 10000:  # 10,000レースまでで打ち切り
    break
```

### 精度が全く上がらない（< 20%）

**チェックリスト:**
- [ ] データが1,000レース以上あるか
- [ ] 各レースに6艇のデータが揃っているか
- [ ] 着順データ（result_position）が正しいか
- [ ] 特徴量が正しく生成されているか

```bash
# デバッグモードで実行
python ml/evaluate_model.py
```

---

## まとめ

### 推奨ワークフロー

```bash
# 1. データ収集（1週間分）
python scraper/collect_all_venues.py

# 2. データ確認
python scraper/verify_data.py

# 3. クイックテスト（デフォルトパラメータ）
python ml/evaluate_model.py

# 4. データが十分にあれば、ハイパーパラメータ最適化
python ml/hyperparameter_tuning.py

# 5. 最適パラメータでモデル訓練
python ml/train_model.py
```

### 精度30-40%達成のための重要ポイント

1. ✅ **データ量**: 10,000レース以上
2. ✅ **ハイパーパラメータ最適化**: `hyperparameter_tuning.py`
3. ⚠️ **天気データの実装**（今後）
4. ⚠️ **会場別統計の詳細化**（今後）
5. ✅ **定期的な再訓練**: 新しいデータで週1回

### 次のステップ

- [ ] 直近1年分のデータ収集完了
- [ ] 初回モデル訓練（デフォルトパラメータ）
- [ ] ハイパーパラメータ最適化実施
- [ ] 最適パラメータでモデル再訓練
- [ ] 精度評価（目標: 30%以上）
- [ ] 天気データ収集機能の実装
- [ ] フロントエンドとの統合

---

**質問や問題がある場合:**
- GitHub Issuesに報告してください
- または設計書（`boatrace-predictor-design.md`）を参照

**成功を祈ります！🚤**
